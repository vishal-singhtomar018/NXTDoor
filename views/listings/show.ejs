<% layout('/layouts/boilerplate') %>

<div class="container mt-4">
  <!-- Filter Bar -->
  <div class="filter-bar">
    <!-- Rent Type -->
    <div class="dropdown">
      <button class="filter-item dropdown-toggle" data-bs-toggle="dropdown">Rent <i class="bi bi-chevron-down"></i></button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#">Rent</a></li>
        <li><a class="dropdown-item" href="#">Lease</a></li>
      </ul>
    </div>

    <!-- City Dropdown -->
    <div class="dropdown">
      <button class="filter-item dropdown-toggle" data-bs-toggle="dropdown">City <i class="bi bi-chevron-down"></i></button>
      <ul class="dropdown-menu" id="city-filter">
        <li><a class="dropdown-item" href="#" data-place="Indore">Indore</a></li>
        <li><a class="dropdown-item" href="#" data-place="Mumbai">Mumbai</a></li>
        <li><a class="dropdown-item" href="#" data-place="Bangalore">Bangalore</a></li>
      </ul>
    </div>

    <!-- Price Dropdown -->
    <div class="dropdown">
      <button class="filter-item dropdown-toggle" data-bs-toggle="dropdown">Budget <i class="bi bi-chevron-down"></i></button>
      <ul class="dropdown-menu" id="priceFilter">
        <li><a class="dropdown-item" href="#" data-range="0-5000">Under ₹5000</a></li>
        <li><a class="dropdown-item" href="#" data-range="5000-10000">₹5000 - ₹10,000</a></li>
        <li><a class="dropdown-item" href="#" data-range="10000-999999">Above ₹10,000</a></li>
      </ul>
    </div>

    <!-- Amenities -->
    <div class="dropdown">
      <button class="filter-item dropdown-toggle" data-bs-toggle="dropdown">Amenities <i class="bi bi-chevron-down"></i></button>
      <ul class="dropdown-menu">
        <li><label class="dropdown-item"><input type="checkbox"> WiFi</label></li>
        <li><label class="dropdown-item"><input type="checkbox"> Parking</label></li>
        <li><label class="dropdown-item"><input type="checkbox"> Pet Friendly</label></li>
      </ul>
    </div>

    <!-- Selected Filters -->
    <div class="filter-item">Flat +1 <i class="bi bi-x"></i></div>
    <div class="filter-item">1 BHK <i class="bi bi-x"></i></div>

    <!-- More Filters -->
    <div class="dropdown">
      <button class="filter-item dropdown-toggle" data-bs-toggle="dropdown">
        <span class="filter-count">3</span> More Filters <i class="bi bi-chevron-down"></i>
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#">Furnished</a></li>
        <li><a class="dropdown-item" href="#">Semi-Furnished</a></li>
        <li><a class="dropdown-item" href="#">Bachelors</a></li>
      </ul>
    </div>
  </div>
</div>

<link rel="icon" href="/images/global-warming-1494965_1280.jpg" type="image/png">

<div class="container my-5">
  <h2 class="text-success mb-4"><%= listing.title %></h2>

  <!-- Main Image + Thumbnails -->
  <div class="main-image-wrapper">
    <div class="position-relative mb-3">
      <img id="mainImage" src="<%= listing.images[0].url %>" class="img-fluid rounded" style="max-height: 400px; object-fit: cover;">
      <div class="position-absolute bottom-0 start-0 bg-dark text-white px-3 py-1 rounded-end">
        <p id="imageLabel" class="mb-0"><%= listing.images[0].label || "Apartment" %></p>
      </div>
    </div>

    <div class="row gx-2 gy-2 justify-content-start">
      <% listing.images.forEach((img)=> { %>
        <div class="col-4 col-md-2">
          <img src="<%= img.url %>" class="img-thumbnail" style="height: 100px; object-fit: cover; cursor: pointer;"
            onclick="changeImage('<%= img.url %>', '<%= img.label || 'Apartment' %>')">
        </div>
      <% }) %>
    </div>
  </div>

  <script>
    function changeImage(url, label) {
      document.getElementById("mainImage").src = url;
      document.getElementById("imageLabel").innerText = label;
    }
  </script>

  <!-- Info Sections -->
  <hr />
  <div class="row g-3 align-items-start">
    <div class="col-md-6">
      <h5>The Space</h5>
      <p><i class="fa fa-male"></i> Max people: <%= listing.Maxpeople %></p>
      <p><i class="fa fa-bath"></i> Bathrooms: <%= listing.Bathrooms %></p>
      <p><i class="fa fa-bed"></i> Bedrooms: <%= listing.Bedrooms %></p>
    </div>
    <div class="col-md-6 pt-4 pt-md-5">
      <p><i class="fa fa-inr"></i> Price: <%= listing.price %></p>
      <p><i class="fa fa-map-marker"></i> Location: <%= listing.location %></p>
      <p><i class="fas fa-map-marked-alt"></i> City: <%= listing.city %></p>
    </div>
  </div>

  <% if (listing.amenities && Object.values(listing.amenities).some(val=> val)) { %>
    <hr>
    <h5>Amenities</h5>
    <div class="row">
      <div class="col-md-6">
        <% if (listing.amenities?.parking) { %>
          <p><i class="fa fa-map-marker"></i> Parking</p>
        <% } %>
        <% if (listing.amenities?.wifi) { %>
          <p><i class="fa fa-wifi"></i> WiFi</p>
        <% } %>
        <% if (listing.amenities?.petFriendly) { %>
          <p><i class="fa fa-paw"></i> Pet Friendly</p>
        <% } %>
      </div>
      <div class="col-md-6">
        <% if (listing.amenities?.kitchen) { %>
          <p><i class="fa fa-cutlery"></i> Kitchen</p>
        <% } %>
        <% if (listing.amenities?.furnished) { %>
          <p><i class="fa fa-couch"></i> Furnished</p>
        <% } %>
        <% if (listing.amenities?.bachelors) { %>
          <p><i class="fa fa-user-check"></i> Bachelors</p>
        <% } %>
      </div>
    </div>
  <% } %>

  <hr />
  <h5><strong>Description</strong></h5>
  <div class="description-box">
    <p><%= listing.description %></p>
  </div>

  <hr />
  <h5>Rules</h5>
  <ul>
    <li><strong>Respect the Property</strong> – Maintain cleanliness and avoid damage.</li>
    <li><strong>No Illegal Activities</strong> - Strictly prohibited within the premises.</li>
    <li><strong>Pet Policy</strong> – Allowed only if specified.</li>
    <li><strong>Use of Amenities</strong> – Keep common areas clean.</li>
    <li><strong>Respect Neighbors</strong> - Avoid conflicts and maintain a friendly environment.</li>
  </ul>

  <% if(currUser && currUser._id.toString()===listing.owner._id.toString()) { %>
    <div class="d-flex gap-3 my-4">
      <div><a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">Edit</a></div>
      <form method="post" action="/listings/<%= listing._id %>?_method=delete">
        <button class="btn btn-danger">Delete</button>
      </form>
    </div>
  <% } %>

  <!-- Review Section -->
  <div>
    <% if(currUser) { %>
      <div class="review-box p-4 shadow-sm rounded-4 bg-white mt-4">
        <h4 class="mb-3 review-title ">Share Your Experience</h4>
        <form action="/listings/<%= listing._id %>/reviews" method="POST" class="needs-validation" novalidate>

          <!-- Rating -->
          <div class="mb-3">
            <label class="form-label d-block"><strong>Your Rating</strong></label>
            <div class="star-rating d-flex align-items-center">
              <% for (let i=1; i<=5; i++) { %>
                <input type="radio" id="star<%= i %>" name="review[rating]" value="<%= i %>" class="d-none">
                <label for="star<%= i %>" class="star" data-value="<%= i %>"><i class="bi bi-star-fill"></i></label>
              <% } %>
              <span id="rating-text" class="ms-2 fw-semibold text-secondary">0.0</span>
            </div>
          </div>

          <!-- Comment -->
          <div class="mb-3">
            <label class="form-label"><i class="bi bi-chat-dots me-1"></i> Your Review</label>
            <textarea name="review[Comment]" class="form-control rounded-3" rows="4"
              placeholder="Tell us about your experience... What did you like? What could be improved?" required></textarea>
            <div class="invalid-feedback">Please provide your review.</div>
          </div>

          <!-- Submit -->
          <button class="btn btn-gradient w-100 py-2 rounded-3 fw-semibold">
            <i class="bi bi-send me-2"></i> Submit Review
          </button>
        </form>
      </div>
    <% } %>
  </div>

  <% if(listing.reviews.length> 0) { %>
    <hr />
    <h5 class="fw-bold mb-4">All Reviews</h5>
    <div class="row">
      <% for (review of listing.reviews) { %>
        <div class="col-md-6 mb-3">
          <div class="review-card shadow-sm p-3 rounded-3 bg-white border">

            <!-- Header: User + Date + Badge -->
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="d-flex align-items-center">
                <div class="rounded-circle bg-gradient text-white fw-bold d-flex justify-content-center align-items-center"
                  style="width:40px; height:40px;">
                  <%= review.author.username.charAt(0).toUpperCase() %>
                </div>
                <div class="ms-2">
                  <h6 class="mb-0"><%= review.author.username %></h6>
                  <small class="text-muted"><i class="bi bi-calendar-event"></i> <%= review.createdAt.toDateString() %></small>
                </div>
              </div>
              <span class="badge bg-success">Excellent</span>
            </div>

            <!-- Rating Stars -->
            <div class="d-flex align-items-center mb-2">
              <div class="review-stars me-2">
                <% for(let i=1; i<=5; i++){ %>
                  <% if(i <=review.rating) { %>
                    <i class="bi bi-star-fill text-warning"></i>
                  <% } else { %>
                    <i class="bi bi-star text-warning"></i>
                  <% } %>
                <% } %>
              </div>
              <span class="fw-bold"><%= review.rating.toFixed(1) %></span>
            </div>

            <!-- Comment -->
            <p class="fst-italic text-muted">"<%= review.Comment %>"</p>

            <!-- Remove Button if Owner -->
            <% if(currUser && currUser._id.toString()===review.author._id.toString()) { %>
              <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=delete" method="POST">
                <button class="btn btn-sm btn-danger">Remove</button>
              </form>
            <% } %>
          </div>
        </div>
      <% } %>
    </div>
  <% } %>

  <div id="map" style="height:400px;"></div>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const listing = <%- JSON.stringify(listing) %>;

      if (listing.latitude && listing.longitude) {
        const lat = parseFloat(listing.latitude);
        const lon = parseFloat(listing.longitude);

        const map = L.map('map').setView([lat, lon], 14);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '© OpenStreetMap'
        }).addTo(map);

        L.marker([lat, lon])
          .addTo(map)
          .bindPopup(`<b>${listing.title}</b><br>${listing.location}, ${listing.city}, ${listing.country}<br>₹${listing.price}`)
          .openPopup();
      } else {
        document.getElementById('map').innerHTML = "<p>Map location not available</p>";
      }
    });
  </script>
  <script>
  const stars = document.querySelectorAll('.star-rating .star');
  const ratingInputs = document.querySelectorAll('.star-rating input');
  const ratingText = document.getElementById('rating-text');

  const messages = ["No Rating", "Poor", "Fair", "Good", "Very Good", "Excellent"];

  stars.forEach(star => {
    star.addEventListener('click', function() {
      const value = this.getAttribute('data-value');

      // Set the corresponding hidden radio input
      document.getElementById(`star${value}`).checked = true;

      // Highlight stars up to clicked one
      stars.forEach(s => s.classList.remove('active'));
      stars.forEach(s => {
        if (s.getAttribute('data-value') <= value) {
          s.classList.add('active');
        }
      });

      // Update text
      ratingText.textContent = `${value}.0 - ${messages[value]}`;
    });
  });
</script>

</div>
